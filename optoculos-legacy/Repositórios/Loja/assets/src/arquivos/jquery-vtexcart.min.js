
/**
 * @license MIT
 * @fileOverview jquery.vtexcart
 * @author Henrique Sosa, henriquesosa@gmail.com
 * @version 1.0.0
 */

/**
 * @param {Object} Options
 * @example
 * $('body').vtexcart({parameters});
 */

var settings = {
	effect: 'overlay'
};

var cart = null;
var helper = {
	openCart : function(){
		var width = $(cart).width() * -1;

		if(settings.effect == "push"){
			$(settings.wrapper).animate({
				marginLeft:width
			});
		}

		$(cart).animate({
			right:0
		});

		$('.sta-cart-overlay').fadeIn();
		$('body').addClass('menuOpen');
	},
	closeCart : function(){
		var width = $(cart).width() * -1;

		if(settings.effect == "push"){
			$(settings.wrapper).animate({
				marginLeft:0
			});
		}

		$(cart).animate({
			right:width - 10
		});

		$('.sta-cart-overlay').fadeOut();
		$('.sta-cart-comfirm').fadeOut();
		$('body').removeClass('menuOpen');
	},
	fillCart : function(){
		setTimeout(function() {
			vtexjs.checkout.getOrderForm().done(function(orderForm) {

				var items = orderForm.items;
				var itemsQtd = items.length
				var i;

				var totalItems;
				var totalShipping;
				var totalDiscount;

				for (var i = 0; i < orderForm.totalizers.length; i++) {
					if(orderForm.totalizers[i].id == "Items") {
						totalItems = orderForm.totalizers[i].value;
					} else if (orderForm.totalizers[i].id == "Shipping") {
						totalShipping = orderForm.totalizers[i].value;							
					} else if (orderForm.totalizers[i].id == "Discounts") {
						totalDiscount = orderForm.totalizers[i].value;
					}
				}

				if (totalItems != undefined) {
					$(cart).find('.sta-cart-sub strong').html('R$ ' + helper.toReal(totalItems));
				} else {
					$(cart).find('.sta-cart-sub strong').html('R$ ' + helper.toReal("000"));
				}
				if (totalShipping != undefined){
					$(cart).find('.sta-cart-freight').css('display','block');
					$(cart).find('.sta-cart-freight strong').html('R$ ' + helper.toReal(totalShipping));
				}
				if (totalDiscount != undefined){
					$(cart).find('.sta-cart-discount').css('display','block');
					$(cart).find('.sta-cart-discount strong').html('R$ ' + helper.toReal(totalDiscount));
				}
				
				$(cart).find('.sta-cart-total strong').html('R$ ' + helper.toReal(orderForm.value));

				if (orderForm.totalizers) {}

				var btnOpenCart = '<i class="ico-bag"></i><span>' + itemsQtd + '</span>';
				
				$('.sta-cart-title .count').text(itemsQtd);
				$('.openCart').html(btnOpenCart);

				$(cart).find('.sta-cart-items > ul').html('');

				if(items.length > 0){

					$('.sta-cart-resume a').removeClass('disabled');

					for(i = 0; i < items.length; i++){

						var pdtName = fns.wrapText(items[i].name, 50, "...");

						var cartItem =   '<li>'
								cartItem +=  '<div class="sta-cart-pdt-image">';
									cartItem +=  '<img src="'+items[i].imageUrl.replace('-55-55','-70-80')+'" />';
								cartItem +=  '</div>';
								cartItem +=  '<div class="sta-cart-pdt-info">';
									cartItem +=  '<h4>'+pdtName+'</h4> ';									
									cartItem +=  '<div class="sta-cart-pdt-other-info">';
										cartItem +=  '<div class="sta-cart-pdt-price">';
											cartItem +=  '<p class="listPrice">R$ '+helper.toReal(items[i].listPrice)+'</p>';
											cartItem +=  '<p class="bestPrice">'+items[i].formattedPrice+'</p>';
	                            		cartItem +=  '</div>';										
                            		cartItem +=  '</div>';
								cartItem +=  '</div>';
								cartItem +=  '<div class="sta-cart-pdt-action">';
									cartItem +=  '<button class="remove-item" data-index="'+i+'"><i class="ico-trash"></i></button>';
								cartItem +=  '</div>';
							cartItem +=  '</li>';

						$(cart).find('.sta-cart-items > ul').append(cartItem);


						if (items[i].listPrice == items[i].price) {
							$('.sta-cart-items > ul > li').eq(i).find('p.listPrice').remove();
						}

					}
				} else{
					$('.sta-cart-resume a').addClass('disabled');
					helper.closeCart();
				}
			});
		}, 500);		
	},
	addItem : function(el){
		var urlTest = ["javascript",":","alert('Por favor, selecione o modelo desejado.');"].join('');
		var url = $(el).attr('href');

		if(url == urlTest){
			alert('Por favor, selecione o modelo desejado.');
			return false;
		} else {
			
			var sku_val = url.split('sku=')[1].split('&')[0];
			var productId = $('#___rc-p-id').val();
			
			$.ajax({
				url: url.replace('true','false'),
				type: 'GET',
				crossDomain: true,
				dataType: 'html',
				success: function(){
					helper.fillCart();
					helper.modalComfirmBild(productId, sku_val);
					helper.openCart();
				}
			});
		}
	},
	changeItem: function(itemIndex, quantity) {
        vtexjs.checkout.getOrderForm().then(function(data) {
            var s = data.items[itemIndex];
            return s.index = itemIndex,
            s.quantity = quantity,
            s.seller = 1,
            vtexjs.checkout.updateItems([s])
        }).done(function(itemIndex) {
            helper.fillCart()
        })
    },
	removeItem : function(index){
		if (confirm('Deseja realmente remover o item do carrinho?')) {
            vtexjs.checkout.getOrderForm().then(function (orderForm) {
                var item = orderForm.items[index];
                item.index = index;
                return vtexjs.checkout.removeItems([item]);
            }).done(function (orderForm) {
                helper.fillCart();
            });
        }
	},
	toReal : function(val){
		val = val / 100;
		val = val.toFixed(2).toString().replace('.',',');		
		return val;
	},
	modalComfirm : function () {
		$('.sta-cart-overlay').fadeIn();
		$('.sta-cart-comfirm').fadeIn();
		$('body').addClass('menuOpen');
	},
	modalComfirmBild : function (productId, skuId) {

		vtexjs.catalog.getProductWithVariations(productId).done(function(product){
			for (var x = 0 ; product.skus.length > x ; x++) {
				if(product.skus[x].sku == skuId) {
					var data = product.skus[x];
					var skuImage = data.image.replace('-780-780','-280-280');
					var skuName = product.name;
					var skuListPrice = data.listPriceFormated;
					var skuBestPrice = data.bestPriceFormated;
					var skuTamanho = data.dimensions.Tamanho;
					var skuCor = data.dimensions.Cor;
					
					var confirmHtml = '<div class="sta-cart-comfirm-overlay"></div>';
						confirmHtml += '<div class="sta-cart-comfirm">';
							confirmHtml += '<div class="close"><i class="ico-close"></i></div>';
							confirmHtml += '<h3>Produto adicionado Ã  sacola!</h3>';
							confirmHtml += '<div class="sta-product-img">';
								confirmHtml += '<div class="image"><img src="'+skuImage+'" /></div>';					
							confirmHtml += '</div>';
							confirmHtml += '<div class="sta-product-info"> ';
								confirmHtml += '<p class="productName">'+skuName+'</p>';
								confirmHtml += '<div class="price">';
									if (skuListPrice != "R$ 0,00") {confirmHtml += '<div class="listPrice">'+skuListPrice+'</div>';}
									confirmHtml += '<div class="bestPrice">'+skuBestPrice+'</div>';
								confirmHtml += '</div>';
								confirmHtml += '<div class="dimensions">';
									confirmHtml += '<ul class="topic Cor">';
									confirmHtml += '<li class="skuespec_Cor_opcao_'+skuCor.replace(" ","-")+' sku-picked">'+skuCor+'</li>';
									confirmHtml += '</ul>';
									confirmHtml += '<ul class="topic Tamanho">';
									confirmHtml += '<li class="skuespec_Tamanho_opcao_'+skuTamanho+' sku-picked">'+skuTamanho+'</li>';
									confirmHtml += '</ul>';
								confirmHtml += '</div>';
								confirmHtml += '<div class="sta-confirm-action">';
										confirmHtml += '<a href="/checkout/#/cart" class="sta-finishShop" title="Finalizar compra">Finalizar compra</a>';
										confirmHtml += '<a href="#" class="sta-keepShop" title="Ver detalhes do Carrinho">Ver detalhes do Carrinho</a>';
								confirmHtml += '</div>';
							confirmHtml += '</div>';
						confirmHtml += '</div>';

					$('body').append(confirmHtml);

					$('.sta-cart-comfirm-overlay').fadeIn();
					$('.sta-cart-comfirm').fadeIn();
					$('body').addClass('menuOpen');

					helper.modalComfirmRemove();
				}
			}
		})		

	},
	modalComfirmRemove: function() {
		$('.sta-cart-comfirm-overlay, .sta-keepShop, .close').on('click', function(e){
			e.preventDefault();
			$('.sta-cart-comfirm-overlay').fadeOut();
			$('.sta-cart-comfirm').fadeOut();
			$('body').removeClass('menuOpen');
			setTimeout(function(){
				$('.sta-cart-comfirm-overlay').remove();
				$('.sta-cart-comfirm').remove();
			}, 600)
		});
	}
};

(function($) {

	$.fn.vtexcart = function(parameters) {

		var el = this;

		settings = $.extend(settings, parameters);

		var cartHtml = '<div class="sta-cart-overlay"></div>';
			cartHtml += '<div class="sta-cart-container">';
				cartHtml += '<div class="sta-cart-title">';
					cartHtml += '<button class="sta-cart-close"><i class="ico-close"></i></button> <h3>Minha sacola</h3>';
				cartHtml += '</div>';
				cartHtml += '<div class="sta-cart-items">';
					cartHtml += '<ul></ul>'; // <-- carrega os itens do carrinho aqui
				cartHtml += '</div>';
				cartHtml += '<div class="sta-cart-resume">';
					cartHtml += '<span class="sta-cart-sub"><em>Subtotal:</em> ';
						cartHtml += '<strong>R$ 0,00</strong>';
					cartHtml += '</span>';
					cartHtml += '<span class="sta-cart-freight"><em>Frete:</em> ';
						cartHtml += '<strong>R$ 0,00</strong>';						
					cartHtml += '</span>';
					cartHtml += '<span class="sta-cart-discount"><em>Desconto:</em> ';
						cartHtml += '<strong>R$ 0,00</strong>';						
					cartHtml += '</span>';
					cartHtml += '<span class="sta-cart-total"><em>Total:</em> ';
						cartHtml += ' <strong> R$0,00</strong>';
					cartHtml += '</span> ';
					cartHtml += '<a class="cartLink" href="/checkout/#/email">finalizar compra</a> ';
					cartHtml += '<a class="checkoutLink" href="/checkout/#/cart">Ir para carrinho</a> ';
				cartHtml += '</div>';
			cartHtml += '</div>';

		var miniCartHtml = '<a href="#" class="openCart"><span></span></a>';

		$(el).append(cartHtml);

		if(settings.cartButton){
			$(settings.cartButton).append(miniCartHtml);
		}

		cart = $(el).find('.sta-cart-container');

		helper.fillCart();

		//DIRECTIVES

		$(settings.buyButton).on('click', function(event){
			event.preventDefault();
			helper.addItem($(this));
		});

		$(".sta-cart-container").on("click", ".list-count-cart a", function(event) {
            event.preventDefault();
            var btnAction = $(this),
              	dataIndex = btnAction.closest(".list-count-cart").attr("data-index"),
              	qtyField = btnAction.closest(".list-count-cart").find(".qty-field"),
              	quantity = parseInt(qtyField.val(), 10) || 0,
              	qtyMin = qtyField.attr("min"),
              	qtyMax = qtyField.attr("max");
            btnAction.hasClass("qty-less") ? quantity != qtyMin && quantity -- : qtyMax > quantity && quantity++,
            helper.changeItem(dataIndex, quantity);
        }),

		$('.openCart').on('click', function(event){
			helper.openCart();

			event.preventDefault();
		});

		$('.sta-cart-close, .sta-cart-overlay, .sta-keepShop').on('click', function(event){
			event.preventDefault();
			helper.closeCart();
		});

		$('.sta-cart-container').on('click','.remove-item', function(){
			var index = $(this).data('index');
			helper.removeItem(index);
		});

		$('.sta-cart-resume a').on('click', function(){
			if($(this).hasClass('disabled')){
				return false;
			}else{
				return true;
			}
		});

		$('.sta-cart-freight button').click(function(){
			$(this).hide();
			$('.sta-cart-freight input').show();
		});
	};
} (jQuery));
$(function() {
    $("body").vtexcart({
        buyButton: $(".buy-button.buy-button-ref"),
        wrapper: $(".wrapper"),
        effect: "overlay",
        cartButton: $(".sta-cart")
    })
    $(document).on('keypress' , '.list-count .qty-field', function(e){
		var tecla = ( window.event ) ? event.keyCode : e.which;   
	    if( ( tecla > 47 && tecla < 58 ) ){
	    	return true;
	    }else{
	    	if ( tecla == 8 || tecla == 0 ){
	    		return true;
	    	}else{
	    		return false;
	    	}
	    }
	});
});